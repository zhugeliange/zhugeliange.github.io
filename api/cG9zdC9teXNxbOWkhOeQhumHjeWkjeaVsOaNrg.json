{"title":"mysql处理重复数据","date":"2017-04-05T03:13:41.000Z","slug":"mysql处理重复数据","comments":true,"tags":["mysql","重复数据"],"categories":["mysql"],"updated":"2019-04-04T03:13:41.000Z","content":"<html><head></head><body><h2 id=\"防止表中出现重复数据\"><a href=\"#防止表中出现重复数据\" class=\"headerlink\" title=\"防止表中出现重复数据\"></a>防止表中出现重复数据</h2><ul><li><p>可以在 <strong>MySQL</strong> 数据表中设置指定的字段为 <strong>PRIMARY KEY</strong>（主键） 或者 <strong>UNIQUE</strong>（唯一） 索引来保证数据的唯一性。</p></li><li><p>如果想设置表中多个字段数据不能重复，可以设置联合主键或者联合唯一索引模式来设置数据的唯一性，此时那个键的默认值就不能为 <strong>NULL</strong>，得设置为 <strong>NOT NULL</strong>。</p></li></ul><figure class=\"highlight sql\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">TABLE</span> 表名</span><br><span class=\"line\">(</span><br><span class=\"line\">   字段<span class=\"number\">1</span> <span class=\"built_in\">CHAR</span>(<span class=\"number\">20</span>) <span class=\"keyword\">NOT</span> <span class=\"literal\">NULL</span>,</span><br><span class=\"line\">   字段<span class=\"number\">2</span> <span class=\"built_in\">CHAR</span>(<span class=\"number\">20</span>) <span class=\"keyword\">NOT</span> <span class=\"literal\">NULL</span>,</span><br><span class=\"line\">   字段<span class=\"number\">3</span> <span class=\"built_in\">CHAR</span>(<span class=\"number\">10</span>),</span><br><span class=\"line\">   PRIMARY <span class=\"keyword\">KEY</span>/<span class=\"keyword\">UNIQUE</span> (字段<span class=\"number\">1</span>, 字段<span class=\"number\">2</span>)</span><br><span class=\"line\">);</span><br></pre></td></tr></tbody></table></figure><ul><li>如果设置了唯一索引，那么在插入重复数据时，<strong>SQL</strong> 语句将无法执行成功,并抛出错。此时可以使用 <strong>INSERT IGNORE INTO</strong>，与 <strong>INSERT INTO</strong> 的区别就是 <strong>INSERT IGNORE INTO</strong> 会忽略数据库中已经存在的数据，如果数据库没有数据就插入新的数据，如果有数据的话就跳过这条数据。这样就可以保留数据库中已经存在数据，达到在间隙中插入数据的目的。</li></ul><figure class=\"highlight sql\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">INSERT</span> <span class=\"keyword\">IGNORE</span> <span class=\"keyword\">INTO</span> 表名 (字段<span class=\"number\">1</span>, 字段<span class=\"number\">2</span>) <span class=\"keyword\">VALUES</span>(值<span class=\"number\">1</span>, 值<span class=\"number\">2</span>);</span><br></pre></td></tr></tbody></table></figure><ul><li>如果在设置了记录的唯一性之后，<strong>INSERT IGNORE INTO</strong> 插入重复数据时将不返回错误，只以警告形式返回。 而使用 <strong>REPLACE INTO</strong> 时，如果重复的记录有主键或者唯一索引，则先删除掉该条记录再插入新记录。</li></ul><h2 id=\"统计重复数据\"><a href=\"#统计重复数据\" class=\"headerlink\" title=\"统计重复数据\"></a>统计重复数据</h2><figure class=\"highlight sql\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> <span class=\"keyword\">COUNT</span>(*) <span class=\"keyword\">as</span> 别名, 字段<span class=\"number\">1</span>, 字段<span class=\"number\">2</span> <span class=\"keyword\">FROM</span> 表名 <span class=\"keyword\">GROUP</span> <span class=\"keyword\">BY</span> 字段<span class=\"number\">1</span>, 字段<span class=\"number\">2</span> <span class=\"keyword\">HAVING</span> 别名 > <span class=\"number\">1</span>;</span><br></pre></td></tr></tbody></table></figure><ul><li><p>确定哪些列包含的值可能会重复。</p></li><li><p>用 <strong>COUNT(*)</strong> 查询这些列的数量。</p></li><li><p>再用 <strong>GROUP BY</strong> 对这些列进行分组。</p></li><li><p>配合 <strong>HAVING</strong> 过滤出重复数大于 <strong>1</strong> 的列。</p></li></ul><h2 id=\"过滤重复数据\"><a href=\"#过滤重复数据\" class=\"headerlink\" title=\"过滤重复数据\"></a>过滤重复数据</h2><figure class=\"highlight sql\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 使用 DISTINCT 来去重</span></span><br><span class=\"line\"><span class=\"keyword\">SELECT</span> <span class=\"keyword\">DISTINCT</span> 字段<span class=\"number\">1</span>,字段<span class=\"number\">2</span> <span class=\"keyword\">FROM</span> 表名;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用 GROUP BY 来去重</span></span><br><span class=\"line\"><span class=\"keyword\">SELECT</span> 字段<span class=\"number\">1</span>,字段<span class=\"number\">2</span> <span class=\"keyword\">FROM</span> 表名 <span class=\"keyword\">GROUP</span> <span class=\"keyword\">BY</span> (字段<span class=\"number\">1</span>,字段<span class=\"number\">2</span>);</span><br></pre></td></tr></tbody></table></figure><h2 id=\"删除重复数据\"><a href=\"#删除重复数据\" class=\"headerlink\" title=\"删除重复数据\"></a>删除重复数据</h2><figure class=\"highlight sql\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 新建一张不重复的表来替换原有的重复表</span></span><br><span class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">TABLE</span> 表<span class=\"number\">2</span> <span class=\"keyword\">SELECT</span> 字段<span class=\"number\">1</span>,字段<span class=\"number\">2</span>,字段<span class=\"number\">3</span> <span class=\"keyword\">FROM</span> 表<span class=\"number\">1</span>  <span class=\"keyword\">GROUP</span> <span class=\"keyword\">BY</span> (字段<span class=\"number\">1</span>,字段<span class=\"number\">2</span>,字段<span class=\"number\">3</span>);</span><br><span class=\"line\"><span class=\"keyword\">DROP</span> <span class=\"keyword\">TABLE</span> 表<span class=\"number\">1</span>;</span><br><span class=\"line\"><span class=\"keyword\">ALTER</span> <span class=\"keyword\">TABLE</span> 表<span class=\"number\">2</span> <span class=\"keyword\">RENAME</span> <span class=\"keyword\">TO</span> 表<span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 添加主键或者唯一索引来删除重复记录</span></span><br><span class=\"line\"><span class=\"keyword\">ALTER</span> <span class=\"keyword\">IGNORE</span> <span class=\"keyword\">TABLE</span> 表名 <span class=\"keyword\">ADD</span> PRIMARY <span class=\"keyword\">KEY</span>/<span class=\"keyword\">UNIQUE</span> (字段<span class=\"number\">1</span>,字段<span class=\"number\">2</span>,字段<span class=\"number\">3</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用子查询删除大于最小值的数据</span></span><br><span class=\"line\"><span class=\"keyword\">DELETE</span> <span class=\"keyword\">FROM</span> 表<span class=\"number\">1</span> 别名<span class=\"number\">1</span> <span class=\"keyword\">WHERE</span> 别名<span class=\"number\">1.</span>字段<span class=\"number\">1</span> > (<span class=\"keyword\">SELECT</span> <span class=\"keyword\">MIN</span>(别名<span class=\"number\">2.</span>字段<span class=\"number\">1</span>) <span class=\"keyword\">FROM</span> 表<span class=\"number\">2</span> 别名<span class=\"number\">2</span> <span class=\"keyword\">WHERE</span> 别名<span class=\"number\">2.</span>主键字段 = 别名<span class=\"number\">1.</span>主键字段);</span><br></pre></td></tr></tbody></table></figure></body></html>","prev":{"title":"mysql高可用架构设计","slug":"mysql高可用架构设计"},"next":{"title":"mysql的alter命令","slug":"mysql的alter命令"},"link":"/post/mysql处理重复数据/","toc":[{"title":"","id":"删除重复数据","index":"1"}],"reward":true,"copyright":{"license":"原创版权，转载请注明来源 (<a href=\\\"https://creativecommons.org/licenses/by-nc-sa/4.0/\\\" rel=\\\"external nofollow noopener\\\" target=\\\"_blank\\\">CC BY-NC-ND 4.0</a>)","author":"沈捷译","link":"<a href=\"/post/mysql处理重复数据/\" title=\"mysql处理重复数据\">/post/mysql处理重复数据/</a>"}}